name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Release, Debug]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libgmp-dev \
          libboost-all-dev

    - name: Configure CMake (Basic)
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
      
    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j4
      
    - name: Test Version
      run: ./build/NexusMiner --version
      
    - name: Upload Binary
      uses: actions/upload-artifact@v4
      if: matrix.build_type == 'Release'
      with:
        name: NexusMiner-Linux-${{ matrix.build_type }}
        path: build/NexusMiner
        retention-days: 7

  build-linux-prime:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libgmp-dev \
          libboost-all-dev

    - name: Configure CMake (With PRIME)
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DWITH_PRIME=ON
      
    - name: Build
      run: cmake --build build --config Release -j4
      
    - name: Test Version
      run: ./build/NexusMiner --version
      
    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: NexusMiner-Linux-Prime
        path: build/NexusMiner
        retention-days: 7
